<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AcquireMock - Checkout</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            gap: 20px;
        }

        .container {
            background: white;
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 440px;
            width: 100%;
            position: relative;
            z-index: 1;
            display: none;
        }

        .container.visible { display: block; animation: slideUp 0.4s ease-out; }

        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-card {
            background: white;
            padding: 32px;
            border-radius: 24px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-align: center;
        }

        .modal-title { font-size: 20px; font-weight: 700; color: #2d3748; margin-bottom: 8px; }
        .modal-desc { font-size: 14px; color: #718096; margin-bottom: 24px; }

        .step-container { display: none; }
        .step-container.active { display: block; animation: fadeIn 0.3s; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 32px 28px; color: white; border-radius: 24px 24px 0 0; }
        .amount-section { padding: 28px; background: #f8f9fa; border-bottom: 1px solid #e9ecef; }
        .amount { font-size: 42px; font-weight: 700; color: #212529; }
        .form-section { padding: 32px 28px; }
        .form-group { margin-bottom: 20px; text-align: left; }
        .form-label { display: block; font-size: 13px; font-weight: 600; color: #495057; margin-bottom: 8px; }
        .form-input { width: 100%; padding: 14px 16px; border: 2px solid #e9ecef; border-radius: 12px; font-size: 16px; transition: all 0.2s ease; }
        .form-input:focus { outline: none; border-color: #667eea; }
        .submit-btn { width: 100%; padding: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; transition: transform 0.2s; }
        .submit-btn:hover { transform: translateY(-2px); }
        .submit-btn:disabled { opacity: 0.7; cursor: wait; }

        .saved-cards-wrapper { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 20px; }
        .saved-card-chip {
            background: #f7fafc; border: 2px solid #edf2f7; padding: 10px 16px; border-radius: 12px;
            font-size: 13px; font-weight: 600; color: #4a5568; cursor: pointer; white-space: nowrap; transition: all 0.2s;
        }
        .saved-card-chip.active { background: #ebf4ff; border-color: #667eea; color: #5a67d8; }

        .history-container { width: 100%; max-width: 440px; margin-top: 20px; display: none; }
        .history-container.visible { display: block; animation: slideUp 0.6s ease-out; }
        .history-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border-radius: 20px; padding: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .history-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .history-item:last-child { border: none; }
        .h-amount { color: #48bb78; font-weight: 700; }

        .checkbox-wrapper { display: flex; align-items: center; gap: 8px; font-size: 14px; color: #4a5568; margin-top: 10px; }

        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes popIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body>

    <div class="modal-overlay" id="emailModal">
        <div class="modal-card">

            <div id="step1" class="step-container active">
                <div class="modal-title">Вхід</div>
                <div class="modal-desc">Введіть ваш Email, щоб продовжити</div>
                <div class="form-group">
                    <input type="email" id="modalEmailInput" class="form-input" placeholder="name@example.com" autofocus>
                </div>
                <button class="submit-btn" onclick="sendAuthCode()">Отримати код</button>
            </div>

            <div id="step2" class="step-container">
                <div class="modal-title">Підтвердження</div>
                <div class="modal-desc">Ми надіслали код на <span id="displayEmail" style="font-weight:600"></span></div>
                <div class="form-group">
                    <input type="text" id="modalCodeInput" class="form-input" placeholder="0000" maxlength="4" style="text-align:center; letter-spacing:4px;">
                </div>
                <button class="submit-btn" onclick="verifyAuthCode()">Увійти</button>
                <div style="margin-top:12px; font-size:13px; color:#667eea; cursor:pointer" onclick="showStep(1)">Змінити Email</div>
            </div>

        </div>
    </div>

    <div class="container" id="mainContainer">
        <div class="header">
            <div style="font-size: 24px; font-weight: 700;">AcquireMock</div>
            <div style="font-size: 14px; opacity: 0.9;">Feane Restaurant</div>
        </div>

        <div class="amount-section">
            <div style="font-size: 13px; color: #6c757d; text-transform: uppercase;">До сплати</div>
            <div class="amount">{{ amount }} ₴</div>
            <div style="margin-top: 8px; color: #6c757d; font-size: 14px;">#{{ reference }}</div>
            <div id="currentUserDisplay" style="margin-top: 12px; font-size: 13px; color: #667eea; font-weight: 600; cursor: pointer;" onclick="resetUser()">
                Змінити акаунт
            </div>
        </div>

        <form id="paymentForm" class="form-section" method="POST" action="/pay/{{ payment_id }}">
            <input type="hidden" name="email" id="hiddenEmail">

            <div id="savedCardsSection" style="display: none;">
                <label class="form-label">Ваші карти</label>
                <div class="saved-cards-wrapper" id="savedCardsList"></div>
            </div>

            <div class="form-group">
                <label class="form-label">Номер картки</label>
                <input type="text" id="cardNumber" name="card_number" class="form-input" placeholder="0000 0000 0000 0000" maxlength="19" required>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                <div class="form-group">
                    <label class="form-label">Термін</label>
                    <input type="text" id="expiry" name="expiry" class="form-input" placeholder="MM/YY" maxlength="5" required>
                </div>
                <div class="form-group">
                    <label class="form-label">CVV</label>
                    <input type="text" id="cvv" name="cvv" class="form-input" placeholder="123" maxlength="3" required>
                </div>
            </div>

            <div class="checkbox-wrapper">
                <input type="checkbox" id="saveCard" name="save_card" value="true">
                <label for="saveCard">Зберегти карту для майбутніх оплат</label>
            </div>

            <button type="submit" class="submit-btn" id="payBtn" style="margin-top: 24px;">Оплатити {{ amount }} ₴</button>
        </form>
    </div>

    <div class="history-container" id="historyContainer">
        <div style="color: white; font-weight: 700; margin-bottom: 12px; padding-left: 4px; text-transform: uppercase; font-size: 14px;">Історія транзакцій</div>
        <div class="history-card" id="historyList"></div>
    </div>

    <script>
        const prefillEmail = "{{ prefill_email if prefill_email else '' }}";
        let currentAuthEmail = "";

        function setCookie(name, value, days) {
            let expires = "";
            if (days) {
                const date = new Date();
                date.setTime(date.getTime() + (days*24*60*60*1000));
                expires = "; expires=" + date.toUTCString();
            }
            document.cookie = name + "=" + (value || "")  + expires + "; path=/";
        }

        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for(let i=0;i < ca.length;i++) {
                let c = ca[i];
                while (c.charAt(0)==' ') c = c.substring(1,c.length);
                if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
            }
            return null;
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (prefillEmail) {
                initializeUser(prefillEmail);
            } else {
                const cookieEmail = getCookie('user_email');
                if (cookieEmail) {
                    initializeUser(cookieEmail);
                } else {
                    document.getElementById('emailModal').style.display = 'flex';
                }
            }
        });

        function showStep(step) {
            document.querySelectorAll('.step-container').forEach(el => el.classList.remove('active'));
            document.getElementById('step' + step).classList.add('active');
        }

        async function sendAuthCode() {
            const email = document.getElementById('modalEmailInput').value;
            if(!email || !email.includes('@')) {
                alert('Введіть коректний Email');
                return;
            }

            const btn = document.querySelector('#step1 .submit-btn');
            btn.disabled = true;
            btn.textContent = 'Відправка...';

            try {
                const res = await fetch('/api/auth/send-code', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({email: email})
                });

                if(res.ok) {
                    currentAuthEmail = email;
                    document.getElementById('displayEmail').innerText = email;
                    showStep(2);
                } else {
                    alert('Помилка відправки коду');
                }
            } catch(e) {
                alert('Помилка мережі');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Отримати код';
            }
        }

        async function verifyAuthCode() {
            const code = document.getElementById('modalCodeInput').value;
            if(code.length < 4) return;

            const btn = document.querySelector('#step2 .submit-btn');
            btn.disabled = true;
            btn.textContent = 'Перевірка...';

            try {
                const res = await fetch('/api/auth/verify-code', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({email: currentAuthEmail, code: code})
                });

                if(res.ok) {
                    setCookie('user_email', currentAuthEmail, 30);
                    initializeUser(currentAuthEmail);
                } else {
                    alert('Невірний код');
                    btn.disabled = false;
                    btn.textContent = 'Увійти';
                }
            } catch(e) {
                alert('Помилка мережі');
                btn.disabled = false;
                btn.textContent = 'Увійти';
            }
        }

        function initializeUser(email) {
            document.getElementById('emailModal').style.display = 'none';
            document.getElementById('mainContainer').classList.add('visible');
            document.getElementById('hiddenEmail').value = email;
            document.getElementById('currentUserDisplay').innerText = email + " (Змінити)";

            fetchUserData(email);
        }

        function resetUser() {
            setCookie('user_email', '', -1);
            location.reload();
        }

        async function fetchUserData(email) {
            try {
                const response = await fetch(`/api/user-info?email=${email}`);
                const data = await response.json();

                const cardsDiv = document.getElementById('savedCardsList');
                const cardsSection = document.getElementById('savedCardsSection');
                cardsDiv.innerHTML = '';

                if (data.cards && data.cards.length > 0) {
                    cardsSection.style.display = 'block';
                    data.cards.forEach(card => {
                        const chip = document.createElement('div');
                        chip.className = 'saved-card-chip';
                        chip.innerText = card.mask;
                        chip.onclick = () => fillCard(card, chip);
                        cardsDiv.appendChild(chip);
                    });
                }

                const histDiv = document.getElementById('historyList');
                const histCont = document.getElementById('historyContainer');
                histDiv.innerHTML = '';

                if (data.operations && data.operations.length > 0) {
                    histCont.classList.add('visible');
                    data.operations.forEach(op => {
                        histDiv.innerHTML += `
                            <div class="history-item">
                                <div>
                                    <div style="font-weight:600; color:#2d3748">${op.reference}</div>
                                    <div style="font-size:11px; color:#718096">${op.date} • ${op.card_mask}</div>
                                </div>
                                <div class="h-amount">+${op.amount} ₴</div>
                            </div>
                        `;
                    });
                }

            } catch (e) {
                console.error("Failed to load user info", e);
            }
        }

        function fillCard(card, element) {
            document.querySelectorAll('.saved-card-chip').forEach(c => c.classList.remove('active'));
            element.classList.add('active');

            document.getElementById('cardNumber').value = card.number;
            document.getElementById('expiry').value = card.expiry;
            document.getElementById('cvv').value = card.cvv;
        }

        document.getElementById('cardNumber').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\s/g, '');
            e.target.value = value.match(/.{1,4}/g)?.join(' ') || value;
        });
        document.getElementById('expiry').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 2) value = value.slice(0, 2) + '/' + value.slice(2, 4);
            e.target.value = value;
        });
    </script>
</body>
</html>